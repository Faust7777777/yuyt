<wxs module="tools">
  // ğŸ”¥ å®‰å…¨è·å–æ—¶æ®µä¿¡æ¯
  var getSlotInfo = function(availableSlots, day, slot) {
    if (!availableSlots || availableSlots.length === 0) return null;
    
    for (var i = 0; i < availableSlots.length; i++) {
      var s = availableSlots[i];
      if (s.day === day && s.slot === slot) {
        return s;
      }
    }
    return null;
  };

  // ğŸ”¥ æ£€æŸ¥æ˜¯å¦æ˜¯æˆ‘çš„é¢„çº¦
  var isMyBooking = function(myBookings, day, slot) {
    if (!myBookings || myBookings.length === 0) return false;
    
    for (var i = 0; i < myBookings.length; i++) {
      var b = myBookings[i];
      if (b.day === day && b.slot === slot) {
        return true;
      }
    }
    return false;
  };

  // æ£€æŸ¥æ˜¯å¦å¯é¢„çº¦
  var isAvailable = function(availableSlots, myBookings, day, slot) {
    if (isMyBooking(myBookings, day, slot)) return false;
    var slotInfo = getSlotInfo(availableSlots, day, slot);
    return slotInfo && !slotInfo.booked;
  };

  // æ£€æŸ¥æ˜¯å¦å·²çº¦æ»¡
  var isBooked = function(availableSlots, myBookings, day, slot) {
    if (isMyBooking(myBookings, day, slot)) return false;
    var slotInfo = getSlotInfo(availableSlots, day, slot);
    return slotInfo && slotInfo.booked;
  };

  // ğŸ”¥ è·å–æ—¶æ®µçŠ¶æ€æ–‡æœ¬
  var getSlotText = function(availableSlots, myBookings, day, slot) {
    if (isMyBooking(myBookings, day, slot)) return 'å·²é¢„çº¦';
    var slotInfo = getSlotInfo(availableSlots, day, slot);
    if (!slotInfo) return '-';
    if (slotInfo.booked) return 'å·²çº¦æ»¡';
    if (slotInfo.availableTeachers && slotInfo.availableTeachers.length > 0) {
      return 'å¯çº¦(' + slotInfo.availableTeachers.length + ')';
    }
    return 'å¯çº¦';
  };

  module.exports = {
    isMyBooking: isMyBooking,
    isAvailable: isAvailable,
    isBooked: isBooked,
    getSlotText: getSlotText
  };
</wxs>

<view class="container">
  <view class="header">
    <text class="title">æ•™å¸ˆç©ºé—²æ—¶é—´</text>
    <text class="subtitle">ç»¿è‰²å¯é¢„çº¦ | è“è‰²å·²é¢„çº¦(ç‚¹å‡»å–æ¶ˆ) | ç°è‰²å·²çº¦æ»¡</text>
  </view>

  <scroll-view scroll-x class="schedule-wrapper">
    <view class="schedule">
      <!-- è¡¨å¤´è¡Œ -->
      <view class="row header-row">
        <view class="cell time-header">æ—¶é—´</view>
        <view 
          class="cell day-header" 
          wx:for="{{weekDays}}" 
          wx:key="index">
          {{item}}
        </view>
      </view>

      <!-- ğŸ”¥ æ—¶é—´è¡Œå¾ªç¯ - ä¿®å¤ç‰ˆ -->
      <view 
        class="row" 
        wx:for="{{timeSlots}}" 
        wx:key="{{index}}"  
        wx:for-item="time"
        wx:for-index="slotIndex">
        
        <!-- æ—¶é—´åˆ— -->
        <view class="cell time-cell">{{time}}</view>
        
        <!-- ğŸ”¥ æ˜ŸæœŸåˆ—å¾ªç¯ - ä½¿ç”¨å›ºå®šçš„ 7 å¤© -->
        <block wx:for="{{weekDays}}" wx:key="day_{{index}}" wx:for-index="dayIndex">
          <view 
            class="cell slot-cell {{tools.isMyBooking(myBookings, dayIndex, slotIndex) ? 'my-booking' : ''}} {{tools.isAvailable(availableSlots, myBookings, dayIndex, slotIndex) ? 'available' : ''}} {{tools.isBooked(availableSlots, myBookings, dayIndex, slotIndex) ? 'booked' : ''}}"
            bindtap="bookSlot"
            data-day="{{dayIndex}}"
            data-slot="{{slotIndex}}">
            
            <text class="slot-text">{{tools.getSlotText(availableSlots, myBookings, dayIndex, slotIndex)}}</text>
          </view>
        </block>
      </view>
    </view>
  </scroll-view>

  <!-- ğŸ”¥ æ•™å¸ˆé€‰æ‹©å¼¹çª— -->
  <view class="teacher-picker-mask" wx:if="{{showTeacherPicker}}" bindtap="cancelPicker">
    <view class="teacher-picker" catchtap="">
      <view class="picker-header">
        <text class="picker-title">é€‰æ‹©æ•™å¸ˆ</text>
        <text class="picker-cancel" bindtap="cancelPicker">å–æ¶ˆ</text>
      </view>
      <view class="teacher-list">
        <view 
          class="teacher-item"
          wx:for="{{currentTeachers}}"
          wx:key="id"
          bindtap="selectTeacher"
          data-teacher-id="{{item.id}}">
          <text class="teacher-name">{{item.name}}</text>
          <text class="teacher-arrow">â€º</text>
        </view>
      </view>
    </view>
  </view>
</view>
